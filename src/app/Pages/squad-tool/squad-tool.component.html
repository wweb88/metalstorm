
<p-breadcrumb [model]="items" [home]="home" />
<h1 class="titleGeneral">Squad Tool</h1>
<p class="paragraphGeneral">
    La aplicaci贸n permite gestionar y analizar informaci贸n de aviones de combate de tu SQUAD para armar escuadrones tentativos; integra datos desde Google Sheets y ofrece un sistema de filtrado avanzado por nivel y tipo de aeronave.
</p>

<div class="fileBox boxCard">
    <div class="fileBox-left">
        <h3>Ingresa la URL del Google Sheets:</h3>
        <div style="display: flex; gap: 10px;">
            <input 
                type="text" 
                [(ngModel)]="urlGoogle" 
                placeholder="https://docs.google.com/spreadsheets/d/..." 
                style="flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;"
                (keyup.enter)="cargarDesdeUrl()"
            />
            <p-button 
                label="Cargar" 
                (click)="cargarDesdeUrl()" 
                [loading]="cargando"
                [disabled]="!urlGoogle || cargando"
            ></p-button>
        </div>
        @if (errorMensaje) {
            <p style="color: #d32f2f; font-size: 12px; margin: 0;">{{ errorMensaje }}</p>
        }
    </div>
    <div class="fileBox-right">
        <p-button 
            label="Descargar plantilla" 
            icon="pi pi-download"
            (click)="abrirModalPlantilla()"
            [style]="{'width': '100%'}"
        ></p-button>
    </div>
</div>

<!-- Modal de descarga de plantilla -->
<p-dialog 
    [(visible)]="mostrarModalPlantilla" 
    [header]="'Descargar Plantilla'" 
    [modal]="true" 
    [style]="{width: '50vw'}"
    [breakpoints]="{'960px': '75vw', '640px': '90vw'}"
    (onHide)="cerrarModalPlantilla()"
>
    <div style="display: flex; flex-direction: column; gap: 15px;">
        <div>
            <h4 style="margin-top: 0; margin-bottom: 10px;">Instrucciones para llenar el documento:</h4>
            <ol style="margin: 0; padding-left: 20px; line-height: 1.8;">
                <li><strong>Nombre de la pesta帽a:</strong> Cada pesta帽a debe tener el nombre del jugador (ej: Jugador1, Jugador2, etc.)</li>
                <li><strong>Primera columna:</strong> No debes modificarla, con ella hacemos el match con nuestra base de datos.</li>
                <li><strong>Segunda columna:</strong> Ingresa el nivel del avi贸n (n煤meros del 1 al 20)</li>
                <li><strong>Formato:</strong> No incluyas encabezados, empieza directamente desde la primera fila con los datos</li>
                <li><strong>Formato:</strong> Puedes agregar m谩s columnas si lo deseas, pero solo las dos primeras ser谩n procesadas</li>
            </ol>
        </div>
        <div style="background-color: #f0f0f0; padding: 10px; border-radius: 4px; border-left: 4px solid #ffc107;">
            <p style="margin: 0; font-size: 13px; color: #333;"><strong>:</strong> La raz贸n de ocupar Google Sheets, es que puedes decirle a tu propio squad que rellene sus datos y as铆 siempre ser谩n due帽os de su informaci贸n.</p>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button 
            label="Cancelar" 
            (click)="cerrarModalPlantilla()" 
            [text]="true"
            severity="secondary"
        ></p-button>
        <p-button 
            label="Descargar" 
            icon="pi pi-download"
            (click)="descargarPlantilla()"
            severity="success"
        ></p-button>
    </ng-template>
</p-dialog>

@if (jugadores.length === 0 && cargando) {
  <div style="display: flex; flex-direction: column; gap: 10px; align-items: center;">
    <p style="color: #666; font-size: 14px;">Cargando datos desde Google Sheets...</p>
  </div>
}



@if (jugadores.length > 0) {
    <div class="boxCard filtersBox">
        <div class="">
            <h3>Selecciona el Nivel:</h3>
            <p-select 
              [options]="nivelesDisponibles" 
              [(ngModel)]="nivelSeleccionado"
              placeholder="Selecciona un nivel"
              optionLabel="label"
              optionValue="value"
              (onChange)="onNivelChange()"
              [style]="{'width': '100%'}"
            ></p-select>
        </div>
        <div class="">
            <div class="typeBox">
                @for (tipo of tiposInfo; track tipo.name) {
                    <div class="typeBox-type">
                        <img [src]="tipo.image" [alt]="tipo.name" [title]="tipo.name" />
                        <p-checkbox 
                        [(ngModel)]="tiposSeleccionados"
                        [value]="tipo.name"
                        [inputId]="tipo.name"
                        (onChange)="aplicarFiltros()"
                        ></p-checkbox>
                    </div>
                }
            </div>
        </div>
        <div class="">
            <h3>Filtrar por:</h3>
            <input 
                type="text" 
                [(ngModel)]="terminoBusqueda" 
                placeholder="Buscar por avi贸n o jugador..." 
                (ngModelChange)="aplicarBusqueda()"
                style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;"
            />
        </div>
    </div>

    <div class="boxCard boxTables">
        <div class="tableResults">
            <h3>Resultados Filtrados</h3>
            @if (resultadosFiltrados.length > 0) {
                <div class="tableResults-table">
                    <p-table [value]="resultadosFiltrados">
                        <ng-template pTemplate="header">
                            <tr>
                                <th class="colType">Tipo</th>
                                <th>Nombre del Avi贸n</th>
                                <th>Nombre del Jugador</th>
                                <th></th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-resultado>
                            <tr>
                                <td class="colType">
                                    <div class="images">
                                        <img [src]="resultado.imagenTipo" [alt]="resultado.tipo" />
                                        <img [src]="resultado.imagenAvion" [alt]="resultado.nombreCompleto" />
                                    </div>
                                </td>
                                <td>{{ resultado.nombreCompleto }}</td>
                                <td>{{ resultado.jugador }}</td>
                                <td style="text-align: center;">
                                    <p-checkbox 
                                    [binary]="true"
                                    [(ngModel)]="resultado.seleccionado"
                                    (onChange)="onToggleSeleccion(resultado)"
                                    ></p-checkbox>
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>
                    
            }
        
            @if (nivelSeleccionado && tiposSeleccionados.length > 0 && resultadosFiltrados.length === 0) {
                <div style="text-align: center; color: #999; margin-top: 20px;">
                No se encontraron resultados para los filtros seleccionados.
                </div>
            }
        </div>
        <div class="tableSelected">
            <h3>Resultados Seleccionados</h3>
            @if (seleccionados.length > 0) {
                <div class="tableSelected-box">
                    <p-table [value]="seleccionados">
                    <ng-template pTemplate="header">
                        <tr>
                            <th class="colType">Tipo</th>
                            <th>Avi贸n</th>
                            <th>Jugador</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-seleccionado>
                        <tr>
                            <td class="colType">
                                <div class="images">
                                    <img [src]="seleccionado.imagenTipo" [alt]="seleccionado.tipo" />
                                    <img [src]="seleccionado.imagenAvion" [alt]="seleccionado.nombreCompleto" />
                                </div>
                            </td>
                            <td>{{ seleccionado.nombreCompleto }}</td>
                            <td>{{ seleccionado.jugador }}</td>
                        </tr>
                    </ng-template>
                    </p-table>
                </div>
            }
        </div>
    </div>
}
